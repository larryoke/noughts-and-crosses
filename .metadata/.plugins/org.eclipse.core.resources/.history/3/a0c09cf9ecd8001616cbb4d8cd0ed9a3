package gameService;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import gameCommon.GameProperties;
import gameCommon.Play;
import gameCommon.PlayResult;
import gameCommon.PlayStatus;
import gameService.service.GameService;

@RestController
@EnableAutoConfiguration
@ComponentScan
public class GameRestController {

    private static final Logger logger = LoggerFactory.getLogger(GameRestController.class);

    @Autowired
    private GameService gameService;

    @RequestMapping("/")
    String home() {
	return "Welcome to the Noughts and crosses Game Service";
    }

    @RequestMapping("/initialise")
    int initNewGame() {
	int id = gameService.initialiseNewGame();
	logger.info("Game ID: " + id);
	return id;
    }

    @RequestMapping(value = "/play", method = RequestMethod.POST)
    public ResponseEntity<PlayResult> processCurrentPlay(@RequestBody Play play) {
	PlayResult result = gameService.processCurrentPlay(play);
	if (PlayStatus.ERROR.equals(result.getPlayStatus())) {
	    return ResponseEntity.badRequest().body(result);
	} else {
	    return ResponseEntity.ok(result);
	}
    }

    /**
     * Clean up the cache, to ensure redundant game object left unused.
     * @param gameID
     */
    @RequestMapping(value = GameProperties.END_GAME, method = RequestMethod.DELETE)
    public void endGame(@PathVariable(value = "gameID") int gameID) {
	gameService.endGame(gameID);
	logger.info("Game ID: " + gameID + " removed");
    }

    public static void main(String[] args) throws Exception {
	SpringApplication.run(GameRestController.class, args);
    }
}
